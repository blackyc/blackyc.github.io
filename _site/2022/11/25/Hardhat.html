<!-- 博文的布局-Layout -->
<!DOCTYPE html>
<html>
<head>
<!-- 引入head标签 -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-sclable=0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="description" content="Cyber Security" />
<meta name="keywords" content="blockchain security,web security,system security..." />
<link rel="stylesheet" href="/assets/css/style.css">
<link rel="stylesheet" href="/assets/css/media.css">
<link rel="stylesheet" href="/assets/css/animate.min.css">
<link rel="stylesheet" href="/assets/css/pygments/pygments_default.css">
<link rel="stylesheet" href="/assets/css/github-markdown.css">
<!-- SNS-icon -->
<script src="//at.alicdn.com/t/font_856428_y9z6nq7zf5.js"></script>
<!-- share.css -->
<link rel="stylesheet" href="/assets/css/share.min.css">
<!-- font -->
<link rel="stylesheet" href="/assets/css/font.css">
<!-- <link href="https://fonts.googleapis.com/css?family=Kaushan+Script|Pacifico|Ubuntu|Roboto+Mono|Source+Sans+Pro" rel="stylesheet"> -->

<!-- Favicon -->
<link href="/assets/profile.jpeg" rel="shortcut icon" />
<link href="/assets/profile.jpeg" rel="apple-touch-icon-precomposed" />
<!-- Android Lolipop Theme Color -->
<!-- <meta name="theme-color" content="#1464FB"> -->
<title>hardhat&foundry</title>
<!-- 百度统计 -->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<!-- 谷歌分析 -->


<!-- Android Lolipop Theme Color -->
<meta name="theme-color" content=" rgb(98,222,189) ">
</head>
<body>

<!-- 顶部锚点 -->
<a id="htmlup" name="htmlup"></a>
<!-- 引入博文顶部选项 -->

<header id="post-header" style="background-color:rgb(98,222,189);">
  <div class="top-center">
      <div class="logo">
          <a href="/" title="my awesome webtitle" style="color: white;">Wake up neo</a>
      </div>
      <nav class="top-nav">
          <ul>
              
                <li><a href="/" style="color: white;">首页</a></li>
              
                <li><a href="/tags.html" style="color: white;">标签</a></li>
              
                <li><a href="/timeline.html" style="color: white;">时间线</a></li>
              
                <li><a href="/about.html" style="color: white;">关于博主</a></li>
              
                <li><a href="/friendLink.html" style="color: white;">友情链接</a></li>
              
          </ul>
      </nav>
      <div id="top-boot">
        <a href="javascript:;" id="boot1" style="display:block;" onclick="document.getElementById('boot-area').style.display='block';document.getElementById('boot1').style.display='none';document.getElementById('boot2').style.display='block';"><img src="/assets/boot_white.png" alt=""></a>
        <a href="javascript:;" id="boot2" style="display: none;" onclick="document.getElementById('boot-area').style.display='none';document.getElementById('boot1').style.display='block';document.getElementById('boot2').style.display='none';"><img src="/assets/boot_white.png" alt=""></a>
      </div>
  </div>

</header>


<!-- 引入移动下拉选项 -->
<div id="boot-area">
    <ul>
        
          <a href="/"><li>首页</li></a>
        
          <a href="/tags.html"><li>标签</li></a>
        
          <a href="/timeline.html"><li>时间线</li></a>
        
          <a href="/about.html"><li>关于博主</li></a>
        
          <a href="/friendLink.html"><li>友情链接</li></a>
        
    </ul>
</div>

<!-- 引入博文顶部样式 -->
<!-- 版本一 垃圾 -->
<!-- <div class="wow fadeIn top" data-wow-duration="3.5s" >
    <span class="wow fadeInUp" data-wow-delay="0.2s">hardhat&foundry</span>
    <span class="wow fadeInUp" data-wow-delay="0.4s"></span>
    <span class="wow fadeInUp" data-wow-delay="0.4s"></span>
    <span class="wow fadeInUp" data-wow-delay="0.6s">作者&nbsp;&nbsp;|&nbsp;&nbsp;true</span>
</div> -->

<!-- 版本二 可切换页面 -->

<div class="post-top" style="background-color:rgb(98,222,189);">
  <!-- 页面宽度大于800px -->
  <div class="left-area">
    
      <a href="javascript:;" class="btn bounceInLeft animated" onmouseover="showLeft();this.style.color='rgb(98,222,189)';" onmouseout="goneLeft();this.style.color='rgba(0,0,0,.2)';"><</a>
      <div id="left-tab" style="display:none;"><span class="left-san"></span><span class="left-main" style="color:rgb(98,222,189);"><sapn class="main">没有上一页咯</sapn></span></div>
    
  </div>
  <div class="post-titlearea">
    <span class="wow fadeInUp" data-wow-delay="0.2s">hardhat&foundry</span>
    <!-- <span class="wow fadeInUp" data-wow-delay="0.4s"></span> -->
    <!-- <span class="wow fadeInUp" data-wow-delay="0.4s"></span> -->
    <!-- <span class="wow fadeInUp" data-wow-delay="0.6s">作者&nbsp;&nbsp;|&nbsp;&nbsp;true</span> -->
  </div>
  <div class="right-area">
    
      <a href="/2022/11/17/BadUsb.html" class="btn bounceInRight self-animated" onmouseover="showRight();this.style.color='rgb(98,222,189)';" onmouseout="goneRight();this.style.color='rgba(0,0,0,.2)';">></a>
      <div id="right-tab" style="display:none;"><span class="right-san"></span><span class="right-main" style="color:rgb(98,222,189);"><sapn class="main">BadUsb HID</sapn></span></div>
    
  </div>

  <!-- 页面宽度小于800px -->
  <div class="post-changearea">
    
      <a href="javascript:;" class="leftchange" style="border-right: 1px solid rgb(98,222,189);border-bottom: 2px solid rgb(98,222,189);"><span><br>没有上一篇咯</span></a>
    
    
      <a href="/2022/11/17/BadUsb.html" class="rightchange" style="border-left: 1px solid rgb(98,222,189);border-bottom: 2px solid rgb(98,222,189);"><span>下一篇<br><br>BadUsb HID</span></a>
    
  </div>
</div>


<div class="markdown-body fadeInUp animated">

  
    
      <div class="postpage-subtitle" style="border-left: 8px solid rgb(98,222,189); border-right: 8px solid rgb(98,222,189)">
        hardhat&foundry by yako33!
      </div>
    
  

  <!-- 文章内容 -->
  <h3 id="hardhatfoundry自动化合约部署与测试模拟攻击">hardhat&amp;foundry自动化合约部署与测试，模拟攻击</h3>

<p>[TOC]</p>

<p>thanks by Frank &amp; Deft(beosin security team)</p>

<h4 id="基础环境">基础环境</h4>
<p>当前实验环境<br />
  windows 10<br />
  Node.js 16.14.0<br />
以空文件夹中加入某ERC20示例代币为例，目录结构(contracts不要命名错误)<br />
  testhardhat<br />
    contracts<br />
      ERC20.sol</p>

<h4 id="创建hardhat项目">创建hardhat项目</h4>
<p>位于testhardhat文件下使用Powershell命令初始化</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">npm</span> <span class="nx">init</span> <span class="o">-</span><span class="nx">y</span>
</code></pre></div></div>
<p>此时会生成package.json，接下来安装Hardhat，这个过程可能会需要耗费些许时间</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">npm</span> <span class="nx">install</span> <span class="nx">hardhat</span>
</code></pre></div></div>
<p>安装结束之后创建项目，官方推荐npx的使用在项目中进行，因为可以根据项目版本进行合理控制。</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">npx</span> <span class="nx">hardhat</span>
</code></pre></div></div>
<p>选择Create an empty hardhat.config.js运行后则会在项目目录中创建一个Hardhat配置文件（hardhat.config.js）</p>
<ul>
<li style="list-style-type: none;">
    <p><img src="http://localhost:4000/screenshot/20221121hardhat/1.png" alt="1" /></p>
  </li>
</ul>

<p>Hardhat项目创建完毕后，可以安装Ethers plugin，为了简化交互</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install @nomiclabs/hardhat-ethers ethers
npm install @nomiclabs/hardhat-waffle
</code></pre></div></div>

<p>为了配置与布局方便，手动添加一个secrets.json文件，用于保存私钥,以ganacha为例，这里配置的是ganache的账户私钥</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="dl">"</span><span class="s2">privateKey0</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">c02541627e8811d4038e2aa96dc613fa6ae2372b993da27ddeb3955b948aad21</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">privateKey1</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">3b9dcc325007c1c616b4b06033a9013a599fdaaa7e770e0f656f7d0710436615</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">privateKey2</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">d45e2033d7214c170311872625c8b47d87d699e538cd7c7da9abf83d7b76151b</span><span class="dl">"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>接下来就可以修改hardhat.config.js文件,此文件中默认为下面代码，而实际上需要根据情况修改solidity的版本,当前测试代币合约为大于0.5.0</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/** @type import('hardhat/config').HardhatUserConfig */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">solidity</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0.8.17</span><span class="dl">"</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<p>通过require导入插件与私钥配置文件</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Import the Ethers plugin required to interact with the contract</span>
<span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@nomiclabs/hardhat-ethers</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Key config path</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">privateKey0</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./secrets.json</span><span class="dl">'</span><span class="p">);</span>

<span class="cm">/** @type import('hardhat/config').HardhatUserConfig */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">solidity</span><span class="p">:</span> <span class="dl">"</span><span class="s2">0.5.17</span><span class="dl">"</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<p>接下来是添加配置代码，使用的网络。</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">networks</span><span class="p">:{</span>
    <span class="c1">// testnet</span>
    <span class="nl">testnet</span><span class="p">:</span> <span class="p">{</span> <span class="c1">//任意的链网络的rpc地址，</span>
      <span class="na">url</span><span class="p">:</span> <span class="s2">`https://rpc.testnet.fantom.network/`</span><span class="p">,</span>
      <span class="na">chainId</span><span class="p">:</span> <span class="mi">4002</span><span class="p">,</span> <span class="c1">//chainID</span>
      <span class="na">accounts</span><span class="p">:</span> <span class="p">[</span><span class="nx">privateKey0</span><span class="p">],</span> <span class="c1">//私钥配置文件中的私钥0</span>
      <span class="na">gas</span><span class="p">:</span><span class="mi">8000000</span>
    <span class="p">},</span>

    <span class="nx">local_network</span><span class="p">:{</span>
    <span class="nl">url</span><span class="p">:</span> <span class="s2">`HTTP://127.0.0.1:7545`</span><span class="p">,</span>
    <span class="nx">accounts</span><span class="p">:</span> <span class="p">[</span><span class="nx">privateKey0</span><span class="p">],</span>
    <span class="nx">gas</span><span class="p">:</span><span class="mi">6721975000</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>最终代码为</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Import the Ethers plugin required to interact with the contract</span>
<span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@nomiclabs/hardhat-ethers</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// Key config path</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">privateKey0</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./secrets.json</span><span class="dl">'</span><span class="p">);</span>

<span class="cm">/** @type import('hardhat/config').HardhatUserConfig */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">solidity</span><span class="p">:</span> <span class="p">{</span><span class="na">compilers</span><span class="p">:[{</span><span class="na">version</span><span class="p">:</span><span class="dl">"</span><span class="s2">0.5.17</span><span class="dl">"</span><span class="p">,</span><span class="na">settings</span><span class="p">:{</span>
    <span class="na">optimizer</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">enabled</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">runs</span><span class="p">:</span> <span class="mi">1000</span>
    <span class="p">}</span>
  <span class="p">}}]},</span>

  <span class="na">networks</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// testnet</span>
    <span class="na">testnet</span><span class="p">:</span> <span class="p">{</span> <span class="c1">//任意的链网络的rpc地址，</span>
      <span class="na">url</span><span class="p">:</span> <span class="s2">`https://rpc.testnet.fantom.network/`</span><span class="p">,</span>
      <span class="na">chainId</span><span class="p">:</span> <span class="mi">4002</span><span class="p">,</span> <span class="c1">//chainID</span>
      <span class="na">accounts</span><span class="p">:</span> <span class="p">[</span><span class="nx">privateKey0</span><span class="p">],</span> <span class="c1">//私钥配置文件中的私钥0</span>
      <span class="na">gas</span><span class="p">:</span><span class="mi">8000000</span>
    <span class="p">},</span>
  
    <span class="na">local_network</span><span class="p">:{</span>
    <span class="na">url</span><span class="p">:</span> <span class="s2">`HTTP://127.0.0.1:8545`</span><span class="p">,</span> <span class="c1">//这里配置为默认ganacha地址</span>
    <span class="na">accounts</span><span class="p">:</span> <span class="p">[</span><span class="nx">privateKey0</span><span class="p">],</span>
    <span class="na">gas</span><span class="p">:</span><span class="mi">6721975000</span> <span class="c1">//每笔交易的上限，即默认的gaslimt</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="部署代码">部署代码</h4>
<p>上面的代码写好之后，可以先进行编译检查是否有错误，包是否配置完毕。successfully则表示编译完成，会生成artifacts与cache文件夹</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">npx</span> <span class="nx">hardhat</span> <span class="nx">compile</span>
</code></pre></div></div>

<p>接下来为方便布局使用创建./scripts/deploy.js，以如下代码布局进行合约部署</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span> <span class="nx">ethers</span>  <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">hardhat</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">privateKey0</span><span class="p">,</span> <span class="nx">privateKey1</span> <span class="p">,</span> <span class="nx">privateKey2</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../secrets.json</span><span class="dl">'</span><span class="p">);</span>

<span class="c1">// 全局定义钱包实例</span>
<span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">HTTP://127.0.0.1:8545</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">Provider</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">providers</span><span class="p">.</span><span class="nx">JsonRpcProvider</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">owner</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">Wallet</span><span class="p">(</span><span class="nx">privateKey0</span><span class="p">,</span> <span class="nx">Provider</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">wallet1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">Wallet</span><span class="p">(</span><span class="nx">privateKey1</span><span class="p">,</span> <span class="nx">Provider</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">wallet2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">Wallet</span><span class="p">(</span><span class="nx">privateKey2</span><span class="p">,</span> <span class="nx">Provider</span><span class="p">);</span>

<span class="c1">//部署函数</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">Deploy</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
        <span class="dl">"</span><span class="s2">Deploy Complete !</span><span class="dl">"</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="c1">//模拟主入口</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">main</span><span class="p">(){</span>
    <span class="nx">Deploy</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// try catch for err</span>
<span class="nx">main</span><span class="p">().</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">exitCode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<p>目前我们除了在console中打印日志没有对合约进行任何操作，使用下面的命令，指定配置的本地网络进行测试</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx hardhat run --network local_network scripts/deploy.js
</code></pre></div></div>
<p>如果没有报错则可以看到控制台打印”Deploy Complete !” (如果报const error/Error: could not detect network检查config中网络是否配置错误)</p>

<h4 id="合约交互">合约交互</h4>

<p>部署合约并打印合约地址</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//部署函数</span>
<span class="k">async</span> <span class="kd">function</span> <span class="nx">Deploy</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//参数为要部署的合约名称，ERC20中代币主合约命OLPC所以这里使用这个名字。</span>
    <span class="kd">const</span> <span class="nx">OLPC</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">getContractFactory</span><span class="p">(</span><span class="dl">"</span><span class="s2">OLPC</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">olpc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">OLPC</span><span class="p">.</span><span class="nx">deploy</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Deploying OPLC...</span><span class="dl">'</span><span class="p">);</span>
    <span class="c1">//等等合约部署完成</span>
    <span class="k">await</span> <span class="nx">olpc</span><span class="p">.</span><span class="nx">deployed</span><span class="p">();</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">OLPC address in:  </span><span class="dl">'</span><span class="p">,</span><span class="nx">olpc</span><span class="p">.</span><span class="nx">address</span><span class="p">)</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
        <span class="dl">"</span><span class="s2">Deploy Complete !</span><span class="dl">"</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>部署中如果有参数需要填写也可以直接加入参数，比如</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">PancakeRouter</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">pancakeRouter</span><span class="p">.</span><span class="nx">deploy</span><span class="p">(</span><span class="nx">MdexFactory</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span> <span class="nx">WETH</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
</code></pre></div></div>
<p>也可以调用合约函数，比如获得uniswap部署时的initcodehash</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//部分代码</span>
<span class="kd">const</span> <span class="nx">mdexFactory</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">getContractFactory</span><span class="p">(</span><span class="dl">"</span><span class="s2">MdexFactory</span><span class="dl">"</span><span class="p">);</span>
<span class="p">...</span>
<span class="kd">const</span> <span class="nx">MdexFactory</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">mdexFactory</span><span class="p">.</span><span class="nx">deploy</span><span class="p">(</span><span class="nx">wallet2</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
<span class="p">...</span>
<span class="kd">const</span> <span class="nx">initCodeHash</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">MdexFactory</span><span class="p">.</span><span class="nx">getInitCodeHash</span><span class="p">();</span>
<span class="p">...</span>
<span class="k">await</span> <span class="nx">MdexFactory</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">wallet2</span><span class="p">).</span><span class="nx">setInitCodeHash</span><span class="p">(</span><span class="nx">initCodeHash</span><span class="p">);</span>
</code></pre></div></div>

<p>如果对于已经部署或者需要初始化的函数则可以直接调用，例如直接调用launchPool初始化</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="nx">poolFactory</span><span class="p">.</span><span class="nx">deployed</span><span class="p">();</span>
<span class="k">await</span> <span class="nx">poolFactory</span><span class="p">.</span><span class="nx">launchPool</span><span class="p">(</span>
  <span class="mi">10</span><span class="p">,</span><span class="mi">1669015872</span><span class="p">,</span><span class="mi">1669019472</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">1000000</span><span class="p">,</span>
  <span class="nx">owner</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span><span class="nx">bUSD</span><span class="p">.</span><span class="nx">address</span>
<span class="p">);</span>
</code></pre></div></div>

<p>当遇见部署或者调用测试脚本时可能遇见不明确的调试信息，这个时候可以尝试直接使用run或者直接调用脚本不指定网络，可能会给出比较正确的报错信息,例如报错数据类型未指定但 又正确声明后的情况。</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">npx</span> <span class="nx">hardhat</span> <span class="nx">run</span> <span class="c1">// npx hardhat run scripts/deploy.js</span>
</code></pre></div></div>

<h4 id="使用hardhat编写测试脚本">使用hardhat编写测试脚本</h4>
<p>为布局创建并使用 ./test/test.js，实际生产中可能也会由ts编写
需要npm安装chai，这是一个断言库文件，安全完毕后可以简单写一个测试文件对刚刚部署的代币进行测试。</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//这是一个断言库</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">expect</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">chai</span><span class="dl">"</span><span class="p">);</span>

<span class="c1">//名称</span>
<span class="nx">describe</span><span class="p">(</span><span class="dl">"</span><span class="s2">OLPC</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//初始化2个账户地址</span>
    <span class="k">async</span> <span class="kd">function</span> <span class="nx">deploy</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="p">[</span><span class="nx">owner</span><span class="p">,</span> <span class="nx">otherAccount</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">getSigners</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">OLPC</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">ethers</span><span class="p">.</span><span class="nx">getContractFactory</span><span class="p">(</span><span class="dl">"</span><span class="s2">OLPC</span><span class="dl">"</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">oplc</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">OLPC</span><span class="p">.</span><span class="nx">deploy</span><span class="p">();</span>
        <span class="k">await</span> <span class="nx">oplc</span><span class="p">.</span><span class="nx">deployed</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">owner:  </span><span class="dl">"</span><span class="p">,</span><span class="nx">owner</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
        <span class="c1">//返回合约，owner方便其他函数调用</span>
        <span class="k">return</span><span class="p">{</span> <span class="nx">oplc</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">otherAccount</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">it</span><span class="p">(</span><span class="dl">"</span><span class="s2">Should set the right owner</span><span class="dl">"</span><span class="p">,</span> <span class="k">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="p">{</span> <span class="nx">oplc</span><span class="p">,</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">otherAccount</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">deploy</span><span class="p">();</span>
        <span class="c1">//调用合约中的已有函数</span>
        <span class="kd">const</span> <span class="nx">balance</span> <span class="o">=</span> <span class="nx">oplc</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">owner</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">owner balance: </span><span class="dl">"</span><span class="p">,</span> <span class="nx">balance</span><span class="p">);</span> 
        <span class="c1">//判断预铸到owner账户是否成功</span>
        <span class="nx">expect</span><span class="p">(</span><span class="k">await</span> <span class="nx">balance</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">5130000</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">6</span><span class="p">));</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">right!</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>
<p>确保使用的命令为</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">npx</span> <span class="nx">hardhat</span> <span class="nx">test</span>
</code></pre></div></div>
<ul>
<li style="list-style-type: none;">
    <p><img src="http://localhost:4000/screenshot/20221121hardhat/2.png" alt="2" /></p>
  </li>
</ul>

<h4 id="在合约中使用consolelog获取信息">在合约中使用console.log获取信息</h4>
<p>首先需要在合约中导入文件</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pragma</span> <span class="nx">solidity</span> <span class="o">^</span><span class="mf">0.5</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="k">import</span> <span class="dl">"</span><span class="s2">hardhat/console.sol</span><span class="dl">"</span><span class="p">;</span>
</code></pre></div></div>
<p>接下来在需要使用的函数中加入console.log</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">balanceOf</span><span class="p">(</span><span class="nx">address</span> <span class="nx">account</span><span class="p">)</span> <span class="kr">public</span> <span class="nx">view</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">uint256</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Sender balance is %s tokens</span><span class="dl">"</span><span class="p">,</span> <span class="nx">_balances</span><span class="p">[</span><span class="nx">account</span><span class="p">]);</span>
    <span class="k">return</span> <span class="nx">_balances</span><span class="p">[</span><span class="nx">account</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>
<ul>
<li style="list-style-type: none;">
    <p><img src="http://localhost:4000/screenshot/20221121hardhat/3.png" alt="3" /></p>
  </li>
</ul>

<h4 id="hardhat-fork链状态">hardhat fork链状态</h4>

<p>启动一个Fork主网的Hardhat Network实例，本地测试复杂的交互,需要启动一个节点来完成，官方推荐Alchemy<br />
<a href="https://learnblockchain.cn/docs/hardhat/guides/mainnet-forking.html">https://learnblockchain.cn/docs/hardhat/guides/mainnet-forking.html</a></p>

<p>拉取节点进行测试</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">npx</span> <span class="nx">hardhat</span> <span class="nx">node</span> <span class="o">--</span><span class="nx">fork</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//eth-mainnet.alchemyapi.io/v2/&lt;key&gt;</span>
</code></pre></div></div>

<p>也可以使用–fork-block-number指定区块</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">npx</span> <span class="nx">hardhat</span> <span class="nx">node</span> <span class="o">--</span><span class="nx">fork</span> <span class="nx">https</span><span class="p">:</span><span class="c1">//eth-goerli.g.alchemy.com/v2/w-pIbpU...tZuzRC9 --fork-block-number 7974072</span>
</code></pre></div></div>

<p>或者使用配置文件fork某个区块上的网络状态，如果不写区块会默认拉取最新的</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">//fork goerli test 固定写法，内置定义，hardhat testnet loacl_network，不能自定义。</span>
    <span class="nx">hardhat</span><span class="p">:</span> <span class="p">{</span>
      <span class="nl">forking</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">url</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://eth-goerli.g.alchemy.com/v2/w-pIbpUV...tZuzRC9</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">blockNumber</span><span class="p">:</span> <span class="mi">7974072</span>
      <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>直接使用命令会默认使用配置的网络，默认会使用8545，需要关闭Ganacha</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">npx</span> <span class="nx">hardhat</span> <span class="nx">node</span>
</code></pre></div></div>
<ul>
<li style="list-style-type: none;">
    <p><img src="http://localhost:4000/screenshot/20221121hardhat/4.png" alt="4" /></p>
  </li>
</ul>

<p>此时在调用测试脚本时则会使用fork网络</p>

<ul>
<li style="list-style-type: none;">
    <p><img src="http://localhost:4000/screenshot/20221121hardhat/5.png" alt="5" /></p>
  </li>
</ul>

<p>在test文件夹下不同的js测试脚本可以指定不同的fork状态，或者重置，params传递空参数则可以禁用</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="nx">network</span><span class="p">.</span><span class="nx">provider</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
  <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">hardhat_reset</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">params</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">forking</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">jsonRpcUrl</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://eth-mainnet.alchemyapi.io/v2/&lt;key&gt;</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">blockNumber</span><span class="p">:</span> <span class="mi">11095000</span>
    <span class="p">}</span>
  <span class="p">}]</span>
<span class="p">})</span>
</code></pre></div></div>

<h4 id="yarn-相关使用">yarn 相关使用</h4>

<p>(待更新)</p>

<h4 id="hardhat-模拟攻击">hardhat 模拟攻击</h4>

<p>(待更新)
目前来看因为学习成本等原因，使用hardhat来完成不太合适，一方面是语言，一方面写起来非常麻烦，暂时研究foundry</p>

<h4 id="foundry-基本环境">foundry 基本环境</h4>

<p>使用foundry需要foundry环境，并且需要rust支持,跟进此处<a href="https://book.getfoundry.sh/getting-started/installation">instructions</a>按照必要的环境</p>

<p>在控制台安装好之后，在项目中运行，这可能会发花费较长的时间</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cargo install --git https://github.com/foundry-rs/foundry foundry-cli anvil --bins --locked
</code></pre></div></div>

<p>(待更新)</p>

<h4 id="用代币来熟悉foundry基本操作">用代币来熟悉foundry基本操作</h4>

<p><a href="https://cloud.tencent.com/developer/article/2010589">方法来源引用链接</a></p>

<p>创建空模板，这一步可能会因为网络或者各种原因各种报错，只能多次安装或者更新。</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>forge init
</code></pre></div></div>
<p>下载OpenZeppelin包并且更新std库</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>forge install OpenZeppelin/openzeppelin-contracts@v4.5.0
forge update foundry-rs/forge-std
</code></pre></div></div>

<p>由于安装多次失败，使用参考文章中的模板进行初始化。</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>forge init --template https://github.com/soliditylabs/forge-erc20-template
</code></pre></div></div>

<p>关于配置文件</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Additional configuration and default values at https://github.com/gakonst/foundry/tree/master/config
[default]

# Sets the concrete solc version to use
# This overrides the `auto_detect_solc` / value auto_detect_solc = true
# 这里是注释了的，可以指定solidity的版本
# solc_version = '0.8.13'

# 指定配置项目的路径，这里是lib/forge-std和openzeppelin
remappings = [
  "ds/=lib/ds-test/src/",
  "@std=lib/forge-std/src/",
  "@openzeppelin=lib/openzeppelin-contracts/contracts/",
]

[ci]
fuzz_runs = 2_000

# 资料夹
# src = 'src'
# 測試檔資料夾
# test = 'test'
# Artifact 資料夾
# out = 'out'

# RPC url。注意如果有提供這個 url，測試會默認你是要用 fork network 執行測試 #eth_rpc_url = 'https://eth-mainnet.alchemyapi.io/v2/API_KEY'
</code></pre></div></div>

<p>基本代币</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="nx">ERC20</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">openzeppelin-contracts/token/ERC20/ERC20.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">MyERC20</span> <span class="nx">is</span> <span class="nx">ERC20</span> <span class="p">{</span>
    <span class="kd">constructor</span><span class="p">()</span> <span class="nx">ERC20</span><span class="p">(</span><span class="dl">"</span><span class="s2">Name</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">SYM</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>测试合约,根据我写的注释来看具体作用</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// SPDX-License-Identifier: MIT</span>
<span class="nx">pragma</span> <span class="nx">solidity</span> <span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="c1">//导入std的包来输出信息，导入测试用的包, /forge-std/src/test/console.sol</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">console</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/console.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">stdStorage</span><span class="p">,</span> <span class="nx">StdStorage</span><span class="p">,</span> <span class="nx">Test</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">forge-std/Test.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="c1">//这2个文件继承了DStest里面有许多使用的函数，创建，断言等等</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">Utils</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./utils/Utils.sol</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">MyERC20</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../MyERC20.sol</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">contract</span> <span class="nx">BaseSetup</span> <span class="nx">is</span> <span class="nx">MyERC20</span><span class="p">,</span> <span class="nx">Test</span> <span class="p">{</span>
    <span class="nx">Utils</span> <span class="nx">internal</span> <span class="nx">utils</span><span class="p">;</span>
    <span class="nx">address</span> <span class="nx">payable</span><span class="p">[]</span> <span class="nx">internal</span> <span class="nx">users</span><span class="p">;</span>

    <span class="nx">address</span> <span class="nx">internal</span> <span class="nx">alice</span><span class="p">;</span>
    <span class="nx">address</span> <span class="nx">internal</span> <span class="nx">bob</span><span class="p">;</span>
    <span class="c1">//Forge中的setUp关键字在每个测试用例运行之前调用的可选函数</span>
    <span class="c1">//还有其他关键词作为函数命名的前缀，test作为测试用例，testFail等等</span>
    <span class="kd">function</span> <span class="nx">setUp</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">virtual</span> <span class="p">{</span>
        <span class="nx">utils</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Utils</span><span class="p">();</span> <span class="c1">//初始化Utils</span>
        <span class="nx">users</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">createUsers</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">//调用创建方法可以创建2个账户</span>

        <span class="nx">alice</span> <span class="o">=</span> <span class="nx">users</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">//在vm中加标签，在堆栈跟踪容易识别</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">label</span><span class="p">(</span><span class="nx">alice</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Alice</span><span class="dl">"</span><span class="p">);</span> <span class="c1">//关于VM众多功能的查看 forge-std/src/Vm.sol</span>
        <span class="nx">bob</span> <span class="o">=</span> <span class="nx">users</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">label</span><span class="p">(</span><span class="nx">bob</span><span class="p">,</span> <span class="dl">"</span><span class="s2">Bob</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">WhenTransferringTokens</span> <span class="nx">is</span> <span class="nx">BaseSetup</span> <span class="p">{</span>
    <span class="nx">uint256</span> <span class="nx">internal</span> <span class="nx">maxTransferAmount</span> <span class="o">=</span> <span class="mi">12</span><span class="nx">e18</span><span class="p">;</span>
    <span class="c1">//类似于beforeEach和describe</span>
    <span class="kd">function</span> <span class="nx">setUp</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">virtual</span> <span class="nx">override</span> <span class="p">{</span>
        <span class="nx">BaseSetup</span><span class="p">.</span><span class="nx">setUp</span><span class="p">();</span> <span class="c1">//调用BaseSetup初始化账户</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">When transferring tokens</span><span class="dl">"</span><span class="p">);</span><span class="c1">//使用console.log来打印日志信息</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">transferToken</span><span class="p">(</span>
        <span class="nx">address</span> <span class="k">from</span><span class="p">,</span>
        <span class="nx">address</span> <span class="nx">to</span><span class="p">,</span>
        <span class="nx">uint256</span> <span class="nx">transferAmount</span>
    <span class="p">)</span> <span class="kr">public</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">prank</span><span class="p">(</span><span class="k">from</span><span class="p">);</span> <span class="c1">//prank(address),将所有后续调用的 msg.sender 设置为输入地址</span>
        <span class="c1">//因为prank修改了调用者，这里使用的this</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">to</span><span class="p">,</span> <span class="nx">transferAmount</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">contract</span> <span class="nx">WhenAliceHasSufficientFunds</span> <span class="nx">is</span> <span class="nx">WhenTransferringTokens</span> <span class="p">{</span>
    <span class="nx">using</span> <span class="nx">stdStorage</span> <span class="k">for</span> <span class="nx">StdStorage</span><span class="p">;</span>
    <span class="nx">uint256</span> <span class="nx">internal</span> <span class="nx">mintAmount</span> <span class="o">=</span> <span class="nx">maxTransferAmount</span><span class="p">;</span>
    <span class="c1">//before初始化</span>
    <span class="kd">function</span> <span class="nx">setUp</span><span class="p">()</span> <span class="kr">public</span> <span class="nx">override</span> <span class="p">{</span>
        <span class="nx">WhenTransferringTokens</span><span class="p">.</span><span class="nx">setUp</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">When Alice has sufficient funds</span><span class="dl">"</span><span class="p">);</span>
        <span class="nx">_mint</span><span class="p">(</span><span class="nx">alice</span><span class="p">,</span> <span class="nx">mintAmount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">itTransfersAmountCorrectly</span><span class="p">(</span>
        <span class="nx">address</span> <span class="k">from</span><span class="p">,</span>
        <span class="nx">address</span> <span class="nx">to</span><span class="p">,</span>
        <span class="nx">uint256</span> <span class="nx">transferAmount</span>
    <span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">uint256</span> <span class="nx">fromBalanceBefore</span> <span class="o">=</span> <span class="nx">balanceOf</span><span class="p">(</span><span class="k">from</span><span class="p">);</span>
        <span class="nx">bool</span> <span class="nx">success</span> <span class="o">=</span> <span class="nx">transferToken</span><span class="p">(</span><span class="k">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">transferAmount</span><span class="p">);</span>
        <span class="c1">// src/test/utils，forge-std中也有，断言函数有相等小于大于(eq,le,ge)  assertTrue判断返回值</span>
        <span class="nx">assertTrue</span><span class="p">(</span><span class="nx">success</span><span class="p">);</span>
        <span class="nx">assertEqDecimal</span><span class="p">(</span>
            <span class="nx">balanceOf</span><span class="p">(</span><span class="k">from</span><span class="p">),</span>
            <span class="nx">fromBalanceBefore</span> <span class="o">-</span> <span class="nx">transferAmount</span><span class="p">,</span>
            <span class="nx">decimals</span><span class="p">()</span>
        <span class="p">);</span>
        <span class="nx">assertEqDecimal</span><span class="p">(</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">to</span><span class="p">),</span> <span class="nx">transferAmount</span><span class="p">,</span> <span class="nx">decimals</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="c1">//带参调用</span>
    <span class="kd">function</span> <span class="nx">testTransferAllTokens</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">itTransfersAmountCorrectly</span><span class="p">(</span><span class="nx">alice</span><span class="p">,</span> <span class="nx">bob</span><span class="p">,</span> <span class="nx">maxTransferAmount</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">testTransferHalfTokens</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">itTransfersAmountCorrectly</span><span class="p">(</span><span class="nx">alice</span><span class="p">,</span> <span class="nx">bob</span><span class="p">,</span> <span class="nx">maxTransferAmount</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">testTransferOneToken</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">itTransfersAmountCorrectly</span><span class="p">(</span><span class="nx">alice</span><span class="p">,</span> <span class="nx">bob</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">testTransferWithFuzzing</span><span class="p">(</span><span class="nx">uint64</span> <span class="nx">transferAmount</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">assume</span><span class="p">(</span><span class="nx">transferAmount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
        <span class="nx">itTransfersAmountCorrectly</span><span class="p">(</span>
            <span class="nx">alice</span><span class="p">,</span>
            <span class="nx">bob</span><span class="p">,</span>
            <span class="nx">transferAmount</span> <span class="o">%</span> <span class="nx">maxTransferAmount</span>
        <span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//签名打包的方式判断，感觉实际上用的很少，这里使用了mockcall模拟调用，如果调用成功会返回ture，使用完之后清空模拟</span>
    <span class="kd">function</span> <span class="nx">testTransferWithMockedCall</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">prank</span><span class="p">(</span><span class="nx">alice</span><span class="p">);</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">mockCall</span><span class="p">(</span>
            <span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
            <span class="nx">abi</span><span class="p">.</span><span class="nx">encodeWithSelector</span><span class="p">(</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">transfer</span><span class="p">.</span><span class="nx">selector</span><span class="p">,</span>
                <span class="nx">bob</span><span class="p">,</span>
                <span class="nx">maxTransferAmount</span>
            <span class="p">),</span>
            <span class="nx">abi</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="nx">bool</span> <span class="nx">success</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">bob</span><span class="p">,</span> <span class="nx">maxTransferAmount</span><span class="p">);</span>
        <span class="nx">assertTrue</span><span class="p">(</span><span class="o">!</span><span class="nx">success</span><span class="p">);</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">clearMockedCalls</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">//vm.load(地址，byte32数据)，从状态读取数据。</span>
    <span class="kd">function</span> <span class="nx">testFindMapping</span><span class="p">()</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nx">uint256</span> <span class="nx">slot</span> <span class="o">=</span> <span class="nx">stdstore</span>
            <span class="p">.</span><span class="nx">target</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
            <span class="p">.</span><span class="nx">sig</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">.</span><span class="nx">selector</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">with_key</span><span class="p">(</span><span class="nx">alice</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">find</span><span class="p">();</span>
        <span class="nx">bytes32</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="nx">address</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">bytes32</span><span class="p">(</span><span class="nx">slot</span><span class="p">));</span>
        <span class="nx">assertEqDecimal</span><span class="p">(</span><span class="nx">uint256</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="nx">mintAmount</span><span class="p">,</span> <span class="nx">decimals</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>做一个带有输入变量的测试函数，forge 会自动进行模糊测试vm.assume排除值，modulo限制为某个值</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function testTransferFuzzing(uint64 amount) public {
    vm.assume(amount != 0);
    itTransfersAmountCorrectly(
        alice,
        bob,
        amount % maxTransferAmount
    );
}
</code></pre></div></div>

<p>依据V数量不同打印不同级别的告警信息。</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>forge test -vvvvv
</code></pre></div></div>
<p>2: 打印所有测试的日志
3: 打印失败的测试的执行堆栈
4: 打印所有测试的执行堆栈，以及失败测试的 setup 堆栈
5: 打印所有测试的执行和 setup 堆栈</p>

<ul>
<li style="list-style-type: none;">
    <p><img src="http://localhost:4000/screenshot/20221121hardhat/6.png" alt="1" /></p>
  </li>
</ul>

<p>其余功能非常多结合漏洞分析一起使用。</p>

<h4 id="foundry-模拟攻击">foundry 模拟攻击</h4>

<p>需要配置RPC</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpc_endpoints = { mainnet = "https://rpc.ankr.com/eth", optimism = "https://rpc.ankr.com/optimism" , fantom = "https://rpc.ankr.com/fantom", arbitrum = "https://rpc.ankr.com/arbitrum", bsc = "https://rpc.ankr.com/bsc", moonriver = "https://moonriver.public.blastapi.io", gnosis = "https://rpc.ankr.com/gnosis", avax = "https://rpc.ankr.com/avalanche", polygon = "https://rpc.ankr.com/polygon"}
</code></pre></div></div>

<p>链fork区块状态</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function setUp() public {
    // the ankr rpc maybe dont work , please use QuickNode 
    cheats.createSelectFork("bsc", 22832427);
}
</code></pre></div></div>

<p>使用标准库基本上能够满足使用，测试exp</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>forge test --contracts ./src/test/MooCAKECTX_exp.sol -vvv
</code></pre></div></div>

<p>(待更新)</p>

  <!-- 引入share模块 -->
  
  <div class="social-share-wrapper">
    <div class="social-share"></div>
  </div>


<!-- share.js -->
<script src="/assets/js/social-share.min.js"></script>
<script>
  socialShare('.social-share', {
    sites: [
      
        'qq'
        ,
        
      
        'wechat'
        ,
        
      
        'weibo'
        ,
        
      
        'twitter'
        ,
        
      
        'facebook'
        
      
    ],
    wechatQrcodeTitle: "分享到微信朋友圈",
    wechatQrcodeHelper: '期待在朋友圈见到这篇文章'
  });
</script>

</div>

<!-- 底部锚点 -->
<a id="htmldown" name="htmldown"></a>
<!-- 引入评论模块 -->



    <section class="post-footer-item comment">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zNDI2OS8xMDgwNg=="></div>
    </section>

    <!-- 来必力City版安装代码 -->
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];

           if (typeof LivereTower === 'function') { return; }

           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;

           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    <!-- City版安装代码已完成 -->





<!-- 引入goto模块 -->
<div class="bounceInRight animated go">
  <a title="顶部切换页面" class="gototop" href="#htmlup" target="_self">
    <div class="box" style="font-family:'ffad_matroregular';">
        Top
    </div>
  </a>
  <a title="底部有livere评论哦" class="gotobottom" href="#htmldown" target="_self">
    <div class="box" style="font-family:'ffad_matroregular';">
        Foot
    </div>
  </a>
</div>

<!-- 引入页面底部模块 -->
<footer id="bottom">
  <br>
  <span>Rookie Hacker ©
  
  
    2018
    -
  
  2022
  <br>
  Powered by <a href="https://www.jekyll.com.cn/">Jekyll</a> | <a href="https://github.com/xukimseven/HardCandy-Jekyll">HardCandy-Jekyll</a></span>
</footer>


<!-- 引用wow.js的动画效果 -->
<script src="/assets/js/wow.js"></script>
<script>
    var wow = new WOW({
        boxClass: 'wow',
        animateClass: 'animated',
        // offset: 600,
        mobile: true,
        live: true
    });
    wow.init();
</script>
<!-- 页面刷新回到顶部 -->
<script>
    window.onbeforeunload = function(){
        //刷新后页面自动回到顶部
        document.documentElement.scrollTop = 0;  //ie下
        document.body.scrollTop = 0;  //非ie
    }
</script>
<script src="/assets/js/main.js"></script>
</body>
</html>
